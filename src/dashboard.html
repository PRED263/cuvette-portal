<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuvette - Job Search</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="font-sans">
    <header class="bg-white shadow-sm p-4 flex justify-between items-center">
        <div class="flex items-center">
            <a href="./index.html">
                <img src="../public/img/cuvette.svg" alt="Cuvette Logo" >
            </a>
        </div>
        <div class="flex items-center space-x-4">
            <span id="userName" class="text-gray-700"></span>
            <button id="logoutBtn" class="text-red-600 hover:text-red-700">Logout</button>
        </div>
    </header>

    <div class="flex">
        <aside class="w-64 bg-white border-r border-gray-200 h-screen">
            <nav class="mt-5 px-2">
                <a href="#" id="fulltimeJobsLink" class="group flex items-center px-2 py-2 text-base leading-6 font-medium rounded-md text-blue-600 bg-gray-100">
                    <svg class="mr-4 h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Fulltime Jobs
                </a>
                <a href="#" id="otherJobsLink" class="mt-1 group flex items-center px-2 py-2 text-base leading-6 font-medium rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <svg class="mr-4 h-6 w-6 text-gray-400 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    Other Jobs
                    <span class="ml-auto inline-block py-0.5 px-2 text-xs font-medium rounded-full bg-green-100 text-green-800">
                        New
                    </span>
                </a>
                <a href="#" id="appliedJobsLink" class="mt-1 group flex items-center px-2 py-2 text-base leading-6 font-medium rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-50">
                    <svg class="mr-4 h-6 w-6 text-gray-400 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Applied
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-10">
            <h1 id="pageTitle" class="text-2xl font-semibold">Fulltime Job Listings</h1>
            <div class="flex mt-6">
                <!-- Job Listings -->
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-4">
                        <input id="searchInput" type="text" placeholder="Search by Role / Skills" class="p-2 border border-gray-300 rounded-md w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="sortSelect" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="date-desc">Sort by (Date) ‚Üì</option>
                            <option value="date-asc">Sort by (Date) ‚Üë</option>
                            <option value="salary-desc">Sort by Salary ‚Üì</option>
                            <option value="salary-asc">Sort by Salary ‚Üë</option>
                        </select>
                    </div>
                    <div id="jobListings" class="space-y-4"></div>
                </div>

                <!-- Sidebar Filters (Moved to Right) -->
                <aside class="w-64 ml-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-medium mb-4">Apply filters</h3>
                        <!-- Office Type -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Office Type</label>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="officeType" value="Remote" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-600">Remote</span>
                                </label>
                                <label class="inline-flex items-center mt-2">
                                    <input type="radio" name="officeType" value="In-Office" class="form-radio">
                                    <span class="ml-2 text-sm text-gray-600">In-Office</span>
                                </label>
                                <label class="inline-flex items-center mt-2">
                                    <input type="radio" name="officeType" value="Hybrid" class="form-radio" checked>
                                    <span class="ml-2 text-sm text-gray-600">Hybrid</span>
                                </label>
                            </div>
                        </div>
                        <!-- Work Experience -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Work Experience</label>
                            <select id="experienceFilter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select experience</option>
                                <option value="0-1">0-1 years</option>
                                <option value="1-3">1-3 years</option>
                                <option value="3-5">3-5 years</option>
                                <option value="5+">5+ years</option>
                            </select>
                        </div>
                        <!-- Min Salary -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Min Salary</label>
                            <input id="salaryFilter" type="range" min="3" max="12" value="6" step="1" class="w-full">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>3 LPA</span>
                                <span>6 LPA</span>
                                <span>8 LPA</span>
                                <span>10 LPA</span>
                                <span>12 LPA</span>
                            </div>
                        </div>
                        <button id="applyFilters" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Apply</button>
                        <button id="clearFilters" class="w-full mt-2 text-gray-600 py-2 rounded-md hover:bg-gray-100">Clear</button>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script type="module">
        import { apiUrl } from './config.js';
        
        const jobListings = document.getElementById('jobListings');
        const pageTitle = document.getElementById('pageTitle');
        const fulltimeJobsLink = document.getElementById('fulltimeJobsLink');
        const otherJobsLink = document.getElementById('otherJobsLink');
        const appliedJobsLink = document.getElementById('appliedJobsLink');
        const profileDropdown = document.getElementById('profileDropdown');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const logoutButton = document.getElementById('logoutButton');
        const userName = document.getElementById('userName');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const experienceFilter = document.getElementById('experienceFilter');
        const salaryFilter = document.getElementById('salaryFilter');
        const applyFilters = document.getElementById('applyFilters');
        const clearFilters = document.getElementById('clearFilters');
    
        let currentCategory = 'Full-time';
        let filters = {
            officeType: 'Hybrid',
            experience: '',
            minSalary: 6,
            search: '',
            sort: 'date-desc'
        };
        let filtersApplied = false;
    
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = './login.html';
        } else {
            fetch(`${apiUrl}/api/user`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                userName.textContent = data.result.name || 'User';
            })
            .catch(() => {
                localStorage.removeItem('token');
                window.location.href = './login.html';
            });
        }
    
        function setActiveLink(activeLink) {
            const links = [fulltimeJobsLink, otherJobsLink, appliedJobsLink];
            links.forEach(link => {
                link.classList.remove('text-blue-600', 'bg-gray-100');
                link.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
                link.querySelector('svg').classList.remove('text-blue-600');
                link.querySelector('svg').classList.add('text-gray-400', 'group-hover:text-gray-500');
            });
            activeLink.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
            activeLink.classList.add('text-blue-600', 'bg-gray-100');
            activeLink.querySelector('svg').classList.remove('text-gray-400', 'group-hover:text-gray-500');
            activeLink.querySelector('svg').classList.add('text-blue-600');
        }
    
        async function handleApply(jobId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = './login.html';
                    return;
                }

                const response = await fetch(`${apiUrl}/jobs/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ jobId })
                });
                const data = await response.json();
                
                if (response.ok) {
                    // Switch to Applied section
                    setActiveLink(appliedJobsLink);
                    pageTitle.textContent = 'Applied Job Listings';
                    await fetchAppliedJobs();
                    alert('Application submitted successfully!');
                } else {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem('token');
                        window.location.href = './login.html';
                    } else {
                        alert(data.message || 'Failed to apply');
                    }
                }
            } catch (error) {
                console.error('Error applying for job:', error);
                alert('Failed to connect to server');
            }
        }
    
        function formatTimeAgo(date) {
            const now = new Date();
            const postedDate = new Date(date);
            const diffMs = now - postedDate;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        function formatApplyBy(date) {
            const applyByDate = new Date(date);
            return applyByDate.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function displayJobs(jobs) {
            jobListings.innerHTML = '';
            if (!jobs || jobs.length === 0) {
                jobListings.innerHTML = '<p class="text-gray-600">No jobs available in this category.</p>';
            } else {
                jobs.forEach(job => {
                    const applicantsText = job.applicants >= 100 ? '100+ applicants' : `${job.applicants || 0} applicants`;
                    const applyByDate = job.applyBy ? new Date(job.applyBy) : new Date(new Date(job.createdAt).getTime() + 30 * 24 * 60 * 60 * 1000);
                    const applyByText = `Apply by ${formatApplyBy(applyByDate)}`;
                    const postedAgoText = `Posted ${formatTimeAgo(job.createdAt)}`;

                    const jobCard = `
                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-xl font-semibold">${job.title}</h2>
                                    <p class="text-gray-600">${job.employerName || 'Unknown Company'} | ${job.location}</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2 text-sm text-gray-500">
                                ${job.tech.map(t => `<span class="px-2 py-1 bg-gray-100 rounded">${t}</span>`).join('')}
                            </div>
                            <div class="grid grid-cols-3 gap-4 mt-4 text-sm text-gray-600">
                                <div>üí∞ Job Offer: ${job.package || 'Not specified'}</div>
                                <div>üìÖ Start Date: ${job.startdate ? new Date(job.startdate).toLocaleDateString() : 'Immediate'}</div>
                                <div>#Ô∏è‚É£ Openings: ${job.openings || 1}</div>
                                <div>‚è≥ Experience: ${job.experience || 'Any'}</div>
                                <div>üè¢ Office Type: ${job.officeType || 'Not specified'}</div>
                            </div>
                            <div class="mt-4 text-sm text-gray-500">${applicantsText} | ${applyByText} | ${postedAgoText}</div>
                            <div class="mt-4 flex justify-between items-center">
                                <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">View Details</button>
                                ${currentCategory !== 'Applied' ? 
                                    job.isApplied ?
                                        '<span class="text-green-600 font-medium">‚úì Applied</span>' :
                                        `<button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 apply-button" data-job-id="${job.id}">Apply Now</button>` 
                                    : '<span class="text-green-600 font-medium">‚úì Applied</span>'}
                            </div>
                        </div>
                    `;
                    jobListings.innerHTML += jobCard;
                });

                // Add event listeners to Apply buttons
                if (currentCategory !== 'Applied') {
                    document.querySelectorAll('.apply-button').forEach(button => {
                        button.addEventListener('click', () => {
                            const jobId = button.getAttribute('data-job-id');
                            handleApply(jobId);
                        });
                    });
                }
            }
        }
    
        async function fetchJobs(category, applyAllFilters = false) {
            try {
                currentCategory = category;
                const queryParamsObj = { type: category };
                
                queryParamsObj.search = filters.search;
                queryParamsObj.sort = filters.sort;
                
                if (applyAllFilters && filtersApplied) {
                    queryParamsObj.officeType = filters.officeType;
                    queryParamsObj.experience = filters.experience;
                    queryParamsObj.minSalary = filters.minSalary;
                }
                
                const queryParams = new URLSearchParams(queryParamsObj).toString();
                const response = await fetch(`${apiUrl}/jobs/?${queryParams}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                displayJobs(data.jobs);
            } catch (error) {
                console.error('Error fetching jobs:', error);
                jobListings.innerHTML = '<p class="text-red-500">Error loading jobs</p>';
            }
        }
    
        async function fetchAppliedJobs() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = './login.html';
                    return;
                }

                currentCategory = 'Applied';
                const response = await fetch(`${apiUrl}/jobs/applied`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (response.ok) {
                    displayJobs(data.jobs);
                } else {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem('token');
                        window.location.href = './login.html';
                    } else {
                        console.error('Failed to fetch applied jobs:', data.message);
                        jobListings.innerHTML = '<p class="text-red-500">Error loading applied jobs</p>';
                    }
                }
            } catch (error) {
                console.error('Error fetching applied jobs:', error);
                jobListings.innerHTML = '<p class="text-red-500">Error loading applied jobs</p>';
            }
        }
    
        fulltimeJobsLink.addEventListener('click', (e) => {
            e.preventDefault();
            setActiveLink(fulltimeJobsLink);
            pageTitle.textContent = 'Fulltime Job Listings';
            fetchJobs('Full-time');
        });
    
        otherJobsLink.addEventListener('click', (e) => {
            e.preventDefault();
            setActiveLink(otherJobsLink);
            pageTitle.textContent = 'Other Job Listings';
            fetchJobs('Part-time');
        });
    
        appliedJobsLink.addEventListener('click', (e) => {
            e.preventDefault();
            setActiveLink(appliedJobsLink);
            pageTitle.textContent = 'Applied Job Listings';
            fetchAppliedJobs();
        });
    
        profileDropdown.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });
    
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = './login.html';
        });
    
        searchInput.addEventListener('input', (e) => {
            filters.search = e.target.value.trim();
            fetchJobs(currentCategory);
        });
    
        sortSelect.addEventListener('change', (e) => {
            filters.sort = e.target.value;
            fetchJobs(currentCategory);
        });
    
        applyFilters.addEventListener('click', () => {
            const selectedOfficeType = document.querySelector('input[name="officeType"]:checked');
            filters.officeType = selectedOfficeType ? selectedOfficeType.value : filters.officeType;
            filters.experience = experienceFilter.value;
            filters.minSalary = parseInt(salaryFilter.value);
            filtersApplied = true;
            fetchJobs(currentCategory, true);
        });
    
        clearFilters.addEventListener('click', () => {
            filters.officeType = 'Hybrid';
            filters.experience = '';
            filters.minSalary = 6;
            filters.search = '';
            filters.sort = 'date-desc';
            filtersApplied = false;
            document.querySelector('input[name="officeType"][value="Hybrid"]').checked = true;
            experienceFilter.value = '';
            salaryFilter.value = 6;
            searchInput.value = '';
            sortSelect.value = 'date-desc';
            fetchJobs(currentCategory);
        });
    
        fetchJobs('Full-time');
    </script>
</body>
</html>